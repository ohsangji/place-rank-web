<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì§€ë³´ë“œ ê´€ë¦¬ì</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Noto Sans KR',sans-serif;background:#f0f2f5;min-height:100vh}
    #loginWrap{display:flex;align-items:center;justify-content:center;min-height:100vh}
    .login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.1);width:360px}
    .login-box h2{text-align:center;margin-bottom:28px;color:#1a1a2e;font-size:22px}
    .login-box input{width:100%;padding:12px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;margin-bottom:14px;outline:none}
    .login-box input:focus{border-color:#4f8ef7}
    .login-box button{width:100%;padding:13px;background:#4f8ef7;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:600}
    .login-box button:hover{background:#3a7ae0}
    .err{color:#e53e3e;font-size:13px;margin-top:8px;text-align:center}
    #adminWrap{display:none;padding:24px}
    .header{background:#fff;padding:16px 24px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .header h1{font-size:20px;color:#1a1a2e}
    .logout-btn{padding:8px 18px;background:#ff5a5a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px}
    .stats{display:flex;gap:16px;margin-bottom:20px}
    .stat-card{background:#fff;padding:20px 28px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);flex:1;text-align:center}
    .stat-card .num{font-size:32px;font-weight:700;color:#4f8ef7}
    .stat-card .label{font-size:13px;color:#888;margin-top:4px}
    .table-wrap{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden}
    .table-header{padding:16px 20px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center}
    .table-header span{font-weight:600;color:#1a1a2e}
    .search-input{padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;width:220px;outline:none}
    table{width:100%;border-collapse:collapse}
    th{background:#fafbfc;padding:12px 14px;font-size:13px;color:#666;font-weight:600;text-align:left;border-bottom:1px solid #eee}
    td{padding:12px 14px;font-size:14px;color:#333;border-bottom:1px solid #f5f5f5;vertical-align:middle}
    tr:hover td{background:#f9fbff}
    .badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
    .badge-admin{background:#fff0e6;color:#e07a2f}
    .badge-general{background:#e8f4fd;color:#2b7ec1}
    .doc-btn{padding:5px 12px;background:#4f8ef7;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px}
    .doc-btn:hover{background:#3a7ae0}
    .no-doc{color:#bbb;font-size:13px}
    .refresh-btn{padding:8px 16px;background:#4f8ef7;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px}
    </style>
  </head>
  <body>
    <div id="loginWrap">
        <div class="login-box">
              <h2>ğŸ” ì´ì§€ë³´ë“œ ê´€ë¦¬ì</h2>
            <input type="text" id="loginId" placeholder="ì•„ì´ë””" />
            <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" />
            <button onclick="doLogin()">ë¡œê·¸ì¸</button>button>
            <div class="err" id="loginErr"></div>div>
        </div>div>
    </div>div>
  
  <div id="adminWrap">
    <div class="header">
        <h1>ğŸ“‹ ì´ì§€ë³´ë“œ íšŒì› ê´€ë¦¬</h1>
        <button class="logout-btn" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>button>
    </div>div>
    <div class="stats">
        <div class="stat-card"><div class="num" id="totalCount">0</div>div><div class="label">ì „ì²´ íšŒì›</div>div></div>div>
        <div class="stat-card"><div class="num" id="generalCount">0</div>div><div class="label">ì¼ë°˜ íšŒì›</div>div></div>div>
        <div class="stat-card"><div class="num" id="bizCount">0</div>div><div class="label">ì‚¬ì—…ì ë“±ë¡ íšŒì›</div>div></div>div>
    </div>div>
    <div class="table-wrap">
        <div class="table-header">
              <span>íšŒì› ëª©ë¡</span>
              <div style="display:flex;gap:10px">
                      <input class="search-input" id="searchInput" placeholder="ì´ë¦„, ì—°ë½ì²˜, íšŒì‚¬ëª… ê²€ìƒ‰..." oninput="renderTable()" />
                      <button class="refresh-btn" onclick="loadUsers()">ìƒˆë¡œê³ ì¹¨</button>button>
              </div>div>
        </div>div>
        <div style="overflow-x:auto">
            <table>
                    <thead>
                              <tr>
                                          <th>No</th><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>íšŒì‚¬ëª…</th>
                              <th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>êµ¬ë¶„</th><th>ê°€ì…ì¼</th><th>ì‚¬ì—…ìë“±ë¡ì¦</th>
                              </tr>
                    </thead>
                  <tbody id="userTbody"></tbody>tbody>
            </table>
        </div>div>
    </div>div>
  </div>div>
  
  <script>
    let TOKEN = localStorage.getItem('adminToken') || '';
    let ALL_USERS = [];

    async function doLogin() {
        const id = document.getElementById('loginId').value.trim();
        const pw = document.getElementById('loginPw').value;
        const r = await fetch('/api/admin/login', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ username: id, password: pw })
        });
        const d = await r.json();
        if (d.success) {
              TOKEN = d.token;
              localStorage.setItem('adminToken', TOKEN);
              showAdmin();
        } else {
              document.getElementById('loginErr').textContent = d.message;
        }
    }

    function doLogout() {
        localStorage.removeItem('adminToken');
        TOKEN = '';
        document.getElementById('loginWrap').style.display = 'flex';
        document.getElementById('adminWrap').style.display = 'none';
    }

    async function showAdmin() {
        document.getElementById('loginWrap').style.display = 'none';
        document.getElementById('adminWrap').style.display = 'block';
        await loadUsers();
    }

    async function loadUsers() {
        const r = await fetch('/api/admin/users', { headers:{'x-admin-token': TOKEN} });
        if (r.status === 401) { doLogout(); return; }
        const d = await r.json();
        ALL_USERS = (d.users || []).filter(u => u.username !== 'admin');
        updateStats();
        renderTable();
    }

    function updateStats() {
        document.getElementById('totalCount').textContent = ALL_USERS.length;
        document.getElementById('generalCount').textContent = ALL_USERS.filter(u => u.memberType !== 'admin').length;
        document.getElementById('bizCount').textContent = ALL_USERS.filter(u => u.bizDoc).length;
    }

    function renderTable() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const filtered = ALL_USERS.filter(u =>
              (u.name||'').toLowerCase().includes(q) ||
              (u.phone||'').includes(q) ||
              (u.company||'').toLowerCase().includes(q) ||
              (u.email||'').toLowerCase().includes(q)
                                            );
        const tbody = document.getElementById('userTbody');
        if (filtered.length === 0) {
              tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#bbb">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
              return;
        }
        tbody.innerHTML = filtered.map((u, i) => `
            <tr>
                  <td>${i+1}</td>
                        <td><strong>${u.name||'-'}</strong></td>
                              <td>${u.username}</td>
                                    <td>${u.company||'-'}</td>
                                          <td>${u.phone||'-'}</td>
                                                <td>${u.email||'-'}</td>
                                                      <td><span class="badge ${u.memberType==='admin'?'badge-admin':'badge-general'}">${u.memberType==='admin'?'ê´€ë¦¬ì':'ì¼ë°˜'}</span></td>
                                                            <td>${u.createdAt||'-'}</td>
                                                                  <td>${u.bizDoc
                                                                                ? `<button class="doc-btn" onclick="downloadDoc('${u.bizDoc}','${u.name}')">ğŸ“„ ë‹¤ìš´ë¡œë“œ</button>`
                                                                                : '<span class="no-doc">ì—†ìŒ</span>'}</td>
                                                                                    </tr>
                                                                                      `).join('');
    }

    async function downloadDoc(filename, name) {
        const r = await fetch('/api/admin/bizdoc/'+filename, { headers:{'x-admin-token': TOKEN} });
        if (!r.ok) { alert('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name+'_ì‚¬ì—…ìë“±ë¡ì¦'+filename.substring(filename.lastIndexOf('.'));
        a.click(); URL.revokeObjectURL(url);
    }

    // ìë™ ë¡œê·¸ì¸ ì‹œë„
    if (TOKEN) { showAdmin(); }

    document.getElementById('loginPw').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
    document.getElementById('loginId').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
  </script>
  </body>
</html>html>
  </script></th></th>
                              </tr>
                    </thead>
            </table></span></h1></h2>
  </body>
  </style></title>
  </head>
